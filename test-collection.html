<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Collection MTG</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; height: 200px; overflow-y: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Test Collection MTG</h1>
    
    <div class="section">
        <h2>1. Test de connexion à l'API</h2>
        <button onclick="testHealthCheck()">Test Health Check</button>
        <button onclick="testAuth()">Test Auth</button>
    </div>
    
    <div class="section">
        <h2>2. Gestion des collections</h2>
        <button onclick="getCollections()">Obtenir Collections</button>
        <button onclick="createTestCollection()">Créer Collection Test</button>
    </div>
    
    <div class="section">
        <h2>3. Gestion des cartes</h2>
        <input type="text" id="cardId" placeholder="ID Scryfall d'une carte" value="f8f8f8f8-1234-1234-1234-123456789abc">
        <button onclick="addCard()">Ajouter Carte</button>
        <button onclick="removeCard()">Supprimer Carte</button>
    </div>
    
    <div class="section">
        <h2>Logs</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Effacer</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentCollection = null;
        let authToken = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function request(method, url, data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (authToken) {
                options.headers.Authorization = `Bearer ${authToken}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`${API_BASE}${url}`, options);
                const result = await response.json();
                
                log(`${method} ${url} - Status: ${response.status}`);
                log(`Response: ${JSON.stringify(result, null, 2)}`);
                
                return { success: response.ok, data: result, status: response.status };
            } catch (error) {
                log(`Erreur: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function testHealthCheck() {
            const result = await request('GET', '/health');
            if (result.success) {
                log('Health check réussi!', 'success');
            } else {
                log('Health check échoué!', 'error');
            }
        }

        async function testAuth() {
            // Test avec un utilisateur fictif (vous devez avoir des utilisateurs dans votre DB)
            const loginData = {
                email: 'test@example.com',
                password: 'password123'
            };
            
            const result = await request('POST', '/auth/login', loginData);
            if (result.success && result.data.token) {
                authToken = result.data.token;
                log('Connexion réussie!', 'success');
            } else {
                log('Connexion échouée. Créez un utilisateur test ou vérifiez vos credentials.', 'error');
            }
        }

        async function getCollections() {
            if (!authToken) {
                log('Vous devez vous connecter d\'abord!', 'error');
                return;
            }

            const result = await request('GET', '/collections');
            if (result.success) {
                const collections = result.data.collections;
                if (collections.length > 0) {
                    currentCollection = collections[0];
                    log(`Collections récupérées: ${collections.length}`, 'success');
                    log(`Collection active: ${currentCollection.name} (${currentCollection._id})`);
                } else {
                    log('Aucune collection trouvée', 'error');
                }
            }
        }

        async function createTestCollection() {
            if (!authToken) {
                log('Vous devez vous connecter d\'abord!', 'error');
                return;
            }

            const collectionData = {
                name: 'Collection Test',
                description: 'Collection de test pour déboggage',
                isPublic: false
            };

            const result = await request('POST', '/collections', collectionData);
            if (result.success) {
                currentCollection = result.data.collection;
                log('Collection créée avec succès!', 'success');
            }
        }

        async function addCard() {
            if (!authToken || !currentCollection) {
                log('Vous devez vous connecter et avoir une collection active!', 'error');
                return;
            }

            const cardId = document.getElementById('cardId').value;
            if (!cardId) {
                log('Veuillez entrer un ID de carte!', 'error');
                return;
            }

            const cardData = {
                card: cardId,
                quantity: 1,
                condition: 'near_mint',
                language: 'fr',
                foil: false
            };

            const result = await request('POST', `/collections/${currentCollection._id}/cards`, cardData);
            if (result.success) {
                log('Carte ajoutée avec succès!', 'success');
            }
        }

        async function removeCard() {
            if (!authToken || !currentCollection) {
                log('Vous devez vous connecter et avoir une collection active!', 'error');
                return;
            }

            // Pour simplifier, on va essayer de supprimer la première carte de la collection
            const result = await getCollections();
            if (currentCollection && currentCollection.cards && currentCollection.cards.length > 0) {
                const cardToRemove = currentCollection.cards[0];
                const deleteResult = await request('DELETE', `/collections/${currentCollection._id}/cards/${cardToRemove._id}`);
                if (deleteResult.success) {
                    log('Carte supprimée avec succès!', 'success');
                }
            } else {
                log('Aucune carte à supprimer!', 'error');
            }
        }

        // Initialisation
        log('Page de test chargée. Commencez par tester la connexion puis l\'authentification.');
    </script>
</body>
</html>
